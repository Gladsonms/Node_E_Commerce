<div id="content" class="site-content">
  <!-- Breadcrumb -->
  <div id="breadcrumb">
    <div class="container">
      <h2 class="title">Shopping Cart</h2>

      <ul class="breadcrumb">
        <li><a href="#" title="Home">Home</a></li>
        <li><span>Shopping Cart</span></li>
      </ul>
    </div>
  </div>

  <div class="container">
    <div class="page-checkout">
      <div class="row">
        <div class="checkout-left col-lg-9 col-md-9 col-sm-9 col-xs-12">
          <p>Returning customer?
            {{!-- <a class="login" href="user-login.html">Click here to login</a>.</p> --}}
          <div class="panel-group" id="accordion">
            <div class="panel panel-default">
              <div class="panel-heading">
                <h4 class="panel-title">
                  <a
                    class="accordion-toggle collapsed"
                    data-toggle="collapse"
                    data-parent="#accordion"
                    href="#collapseOne"
                  >
                    Address
                  </a>
                </h4>
              </div>
              <div
                id="collapseOne"
                class="accordion-body collapse"
                style="height: 0px;"
              >
                <div class="panel-body">
                  <form id="formaddress" onsubmit=" return addAddress()" method="post" action="/cart/checkout/addAddress" class="form-horizontal" >

                    <div class="form-group">
                      <div class="col-md-6">
                        <label>User Name</label>
                        <input
                          type="text"
                          value=""
                          class="form-control"
                          name="name"
                          id="name"
                        />
                         <p class="text-danger" id="nameError"></p>
                      </div>
                      <div class="col-md-6">
                        <label>phone number</label>
                        <input
                          type="number"
                          value=""
                          class="form-control"
                          name="phone"
                          id="phone"
                        />
                         <p class="text-danger" id="phoneError"></p>
                      </div>
                    </div>
                    <div class="form-group">
                      <div class="col-md-12">
                        <label>Place</label>
                        <input
                          type="text"
                          value=""
                          class="form-control"
                          name="place"
                          id="place"
                        />
                         <p class="text-danger" id="placeError"></p>
                      </div>
                    </div>
                    <div class="form-group">
                      <div class="col-md-12">
                        <label>Address </label>
                        <input
                          type="text"
                          value=""
                          class="form-control"
                          name="address"
                          id="address"
                        />
                         <p class="text-danger" id="addressError"></p>
                      </div>
                    </div>
                    <div class="form-group">
                      <div class="col-md-6">
                        <label>City </label>
                        <input
                          type="text"
                          value=""
                          class="form-control"
                          name="city"
                          id="city"
                        />
                         <p class="text-danger" id="cityError"></p>
                      </div>
                      <div class="col-md-6">
                        <label>Pincode </label>
                        <input
                          type="text"
                          value=""
                          class="form-control"
                          name="pincode"
                          id="pincode"
                        />
                         <p class="text-danger" id="pincodeError"></p>
                      </div>
                    </div>
                    <div class="form-group">
                      <div class="col-md-12">
                        <button
                          type="submit"
                          value="Save"
                          class="btn pull-right"
                        >submit</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            {{! <form action="/cart/checkout/placeorder" method="post"> }}

            <form action="" id="placeorderform">
              <div class="mt-3">
                <label for="">Choose Address   </label>
                {{#each useraddres.address}}
					
						<div class="mt-2">
						  
						<input type="radio"  name="address" value="{{this.name}} ,  {{this.phone}}  ,  {{this.place}},  {{this.address}} ,  {{this.city}} "  /> <label for="">{{this.name}}   {{this.phone}}    {{this.place}}  {{this.address}}   {{this.city}}  </label>
                  {{!-- <a   class="btn btn-sm btn btn-danger ml-3 text-light"  onclick="removeAddress('{{this.id}}','{{this.name}}','{{../useraddres._id}}')"> Remove address</a> --}}
							</div>
              
											
                      						
                                             {{/each}}
                

              </div>

              <div class="panel panel-default">
                <div class="panel-heading">
                  <h4 class="panel-title">
                    <a
                      class="accordion-toggle collapsed"
                      data-toggle="collapse"
                      data-parent="#accordion"
                      href="#collapseThree"
                    >
                      Payment
                    </a>
                  </h4>
                </div>
                <div
                  id="collapseThree"
                  class="accordion-body collapse"
                  style="height: 0px;"
                >
                  <div class="panel-body">
                    {{!-- <table class="cart-summary table table-bordered">
                      <thead>
                        <tr>
                          <th class="width-80 text-center">Image</th>
                          <th>Name</th>
                          <th class="width-100 text-center">Unit price</th>
                          <th class="width-100 text-center">Qty</th>
                          <th class="width-100 text-center">Total</th>
                        </tr>
                      </thead>

                      <tbody>
                        <tr>
                          <td>
                            <a href="product-detail-left-sidebar.html">
                              <img
                                width="80"
                                alt="Product Image"
                                class="img-responsive"
                                src="img/product/19.jpg"
                              />
                            </a>
                          </td>
                          <td>
                            <a
                              href="product-detail-left-sidebar.html"
                              class="product-name"
                            >Organic Strawberry Fruits</a>
                          </td>
                          <td class="text-center">
                            $265
                          </td>
                          <td class="text-center">
                            1
                          </td>
                          <td class="text-center">
                            $265
                          </td>
                        </tr>

                        <tr>
                          <td>
                            <a href="product-detail-left-sidebar.html">
                              <img
                                width="80"
                                alt="Product Image"
                                class="img-responsive"
                                src="img/product/31.jpg"
                              />
                            </a>
                          </td>
                          <td>
                            <a
                              href="product-detail-left-sidebar.html"
                              class="product-name"
                            >Organic Strawberry Fruits</a>
                          </td>
                          <td class="text-center">
                            $150
                          </td>
                          <td class="text-center">
                            2
                          </td>
                          <td class="text-center">
                            $300
                          </td>
                        </tr>
                      </tbody>
                    </table> --}}

                    <h4 class="heading-primary">Cart Total</h4>
                    <table class="table cart-total">
                      <tbody>
                        <tr>
                          <th>
                            Cart Subtotal
                          </th>
                          <td class="total">
                             ₹{{total}}
                          </td>
                        </tr>
                        <tr>
                          <th>
                            Shipping
                          </th>
                          <td>
                            Free Shipping
                          </td>
                        </tr>
                        <tr>
                          <th>
                            <strong>Order Total</strong>
                          </th>
                          <td class="total">
                           ₹{{totalPrice}}
                          </td>
                        </tr>
                      </tbody>
                    </table>

                    <h4 class="heading-primary">Payment</h4>
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="radio"
                        name="payment"
                        id="flexRadioDefault1"
                        value="cod"
                      />
                      <label class="form-check-label" for="flexRadioDefault1">
                        Cash on deleviery
                      </label>
                    </div>
                    <div class="form-check">
						<input type="text" name="userId" value="{{user._id}}" hidden>
                      <input
                        class="form-check-input"
                        type="radio"
                        name="payment"
                        id="flexRadioDefault2"
                        value="razorpay"
                      />
                      <label class="form-check-label" for="flexRadioDefault2">
                       Razorpay
                      </label>
                    </div>
                     <div class="form-check">
						<input type="text" name="userId" value="{{user._id}}" hidden>
                      <input
                        class="form-check-input"
                        type="radio"
                        name="payment"
                        id="flexRadioDefault3"
                        value="paypal"
                      />
                      <label class="form-check-label" for="flexRadioDefault3">
                       Paypal
                      </label>
                    </div>

                   

                  </div>
                </div>
              </div>

              <div class="pull-right mt-4">
                <input
                  type="submit"
                  value="Place Order"
                  name="proceed"
                  class="btn btn-primary"
                />
              </div>
            </form>
          </div>

        </div>

        <div class="checkout-right col-lg-3 col-md-3 col-sm-3 col-xs-12">
          <h4 class="title">Cart Total</h4>
          <table class="table cart-total" id="tableAmount">
            <tbody>
              <tr class="cart-subtotal">
                <th>
                  <strong>Cart Subtotal</strong>
                </th>
                <td>
                  <strong><span class="amount">₹{{totalPrice}}</span></strong>
                </td>
              </tr>
              <tr class="shipping">
                <th>
                  Shipping
                </th>
                <td>
                  Free Shipping<input
                    type="hidden"
                    value="free_shipping"
                    class="shipping-method"
                    name="shipping_method"
                  />
                </td>
              </tr>
              <tr class="total">
                <th>
                  <strong>Order Total</strong>
                </th>
                <td>
                  <strong><span id="totaount">₹{{totalPrice}}</span></strong>
                  <span id="totalAmount"></span>
                </td>
                <td>

                </td>
                
              </tr>
              <tr class="coupon">
              <th>
                Add coupon
              </th>
                <form id="applyCoupon">
              <td><input type="text" name="coupon" id="appliedCoupon"/></td>  </tr>
             <tr><td><input type="hidden"></td> <td><button class="btn btn-sm-success"> Apply coupon</button></td></tr>
             <tr><td> <span id="msgsuccess"></span></td></tr>
              <tr><td> <span id="msgfail"></span></td></tr> 
              <tr><td> <span id="msgfailed"></span></td></tr>       
                     
                </form>
              
            
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
 <script
    src="https://www.paypal.com/sdk/js?client-id=AWp1ywqyrlAJ8UAwiDeqJRu77Mr80YUAoKV862hKJ8gLsLmMk1BNhTB-BwrSzEJcfZJiZ3Z4Bla9rghu"> // Required. Replace YOUR_CLIENT_ID with your sandbox client ID.
  </script>
   <script>
    paypal.Buttons().render('#paypal-button-container');
    // This function displays Smart Payment Buttons on your web page.
  </script>







<script>

   document.getElementById("applyCoupon").onsubmit=e=>{
     e.preventDefault();
      $.ajax({
        url:"/apply-coupon",
        method:"POST",
        data:$("#applyCoupon").serialize(),
        success:(response)=>{
         
                 if(response.newPrice){

                let price =  document.getElementById("totaount").innerHTML=response.newPrice;  
               
                 document.getElementById("totaount").innerHTML
                 document.getElementById("msgsuccess").innerHTML=response.message
                 document.getElementById("msgfail").innerHTML=" "
                 }
                 else if(response.couponMessage == true)
                 {
                   document.getElementById("msgfail").innerHtml=" "
                  document.getElementById("msgfailed").innerHtml=response.Amessage



                 }
        }
      })
   }


       ////To check Name  in form
var nameField = document.getElementById('name')
var validname=false;


nameField.addEventListener('input', (e) => {
    var name = nameField.value
    var nameRegex=/^[a-zA-Z ]+$/ 

    if(name.length==0){
        text="Please Enter your Name";
        nameError.innerHTML = text;
        validname=false;
    } 
    else if(name.length<5){
        console.log(name.length);
        nameError.innerHTML="Name should be more than 4 Characters"
        validname=false;
    }
    else if(name.includes('  ')){
        nameError.innerHTML="Name should not contain 2 concecutive spaces"
        validname=false;


    }
    else if(!name.match(nameRegex))
    {
        text="Name Should not contain numeric value"
        nameError.innerHTML=text;
        return false;
    }
    else{

        validname=true;
        nameError.innerHTML=" ";
   
      }
})

////To Check Number is valid or not
var phoneField = document.getElementById('phone')
var validphone=false;
phoneField.addEventListener('input',()=>{
    var phone=phoneField.value
    if(isNaN(phone) || phone.length==0){
         validphone=false;
        text="This field should not be blank";
        phoneError.innerHTML = text;
   
} else if(isNaN(phone) || phone.length!=10){
     validphone=false;
    text="Please Enter Valid Number";
    phoneError.innerHTML = text;
   
}else{
    phoneError.innerHTML=" ";
     validphone=true;
}     
})



//////To check address is on or present or not
var addressField=document.getElementById('address')
var validaddress=false;
addressField.addEventListener('input',(e)=>{
    var address=addressField.value
    if(address.length<=10){
        validaddress=false;
        text="Please Enter More Than 10 Characters"
        addressError.innerHTML = text;
       
    }else{
        validaddress=true;
        text=" "
        addressError.innerHTML=text;
        
    }
})




//////To check city is on or present or not
var cityField=document.getElementById('city')
var validcity=false;
cityField.addEventListener('input',(e)=>{
    var city=cityField.value
    if(city.length<=3){
        validcity=false;
        text="Please Enter More Than 3 Characters"
        cityError.innerHTML = text;
       
    }else{
        validcity=true;
        text=" "
        cityError.innerHTML=text;
        
    }
})



//////To check pincode is on or present or not
var pincodeField=document.getElementById('pincode')
var validpincode=false;
pincodeField.addEventListener('input',(e)=>{
    var pincode=pincodeField.value
    if(pincode.length!==6){
       
        text="Please Enter   6 digit"
        pincodeError.innerHTML = text;
       validpincode=false;
    }else{
        validpincode=true;
        text=" "
        pincodeError.innerHTML=text;
        
    }
})


//////To check place is on or present or not
var placeField=document.getElementById('place')
var validplace=false;
placeField.addEventListener('input',(e)=>{
    var place=placeField.value
    if(place.length<=3){
      
        text="Please Enter More Than 3 Characters"
        placeError.innerHTML = text;
       validplace=false;
    }else{
        validplace=true;
        text=" "
        placeError.innerHTML=text;
        
    }
})
 

   </script>
   <script>
     var newCoupon 

     $('#placeorderform').submit((e)=>{ 
        e.preventDefault() 
           
      var newCouponcode = document.getElementById("appliedCoupon").value;
      
     

	 
     
  
	  $.ajax({
  url:"/place-order",
   method:"post",
    data:$('#placeorderform').serialize()+"&couponCode="+newCouponcode,
  success:(response)=>
  { 
	
	console.log(response)
   if(response.codSuccess)
   {
     
	   location.href='/order-success'
   }
    else if(response.razorpaySuccess){
     
     razorPayPayment(response.data)
     // location.href='/order-success'

   }
   

   else{
     
    location.href=response

   }
  }
   })
   })

    function razorPayPayment(order){
      var options = {
    "key": "rzp_test_wof2EdLxFrX857", // Enter the Key ID generated from the Dashboard
    "amount":order.amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
    "currency": "INR",
    "name": "Gkart",
    "description": "Test Transaction",
    "image": "https://example.com/your_logo",
    "order_id": order.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
    "handler": function (response){
        

        verifyPayment(response,order)
    },
    "prefill": {
        "name": "Gaurav Kumar",
        "email": "gaurav.kumar@example.com",
        "contact": "9999999999"
    },
    "notes": {
        "address": "Razorpay Corporate Office"
    },
    "theme": {
        "color": "#3399cc"
    }
};
    var rzp1 = new Razorpay(options);
     rzp1.open();
    }

        
        function verifyPayment(payment,order){
               $.ajax({
                 url:'/verify-payment',
                 data:{
                   payment,
                   order
                 },
                 method:"post",
                 success:(response)=>{
                   if(response.status){
                     //location.href='/order-success'
                     alert("delete cart")
                     $.ajax({
                       url:"/delete-cart-product",
                       method:"post",
                       data:{
                         order
                       },
                       success:(response)=>{
                         if(razorpaySuccess)
                         {

                        location.href='/order-success'
                         }
                       }
                     })
                   }
                   else {
                     swal("Payment Failed")
                   }
                 }
               })
        }
    

  function addAddress(){
   
    if(validname && validphone && validpincode && validcity && validaddress && validplace)
    {
      return true
    }else

    {
      swal("Please fill all fileds")
      return false
    }
  }
   
</script>
<script>
   function removeAddress(address,name,addressId){
   
   
       $.ajax({
         url:"/oders/deleteaddress",
         method:"post",
         data:{
           address:address,
           name:name,
          addressId:addressId
         },
         success:(status)=>{
           window.location.href ="/cart/checkout"
         }
       })
   }




</script>
